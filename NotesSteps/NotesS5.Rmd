---
title: "NotesS5"
author: "Andrew Wang"
date: "2024-02-02"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# clean up and setup
rm(list=ls()) # clean up any old stuff in R

library(tidyverse)
library(dplyr)
library(lubridate)
library(ggplot2)
library(zoo)

setwd("C:/Users/hyper/OneDrive/Documents/GitHub/Insurance-Corporate-Bonds")

df <- readRDS('insurers_transactions.rds')
brokers <- read.csv('brokers.csv')

#Basic filtering conducted on the read-in data 
df <- df[df$trade_cost > 0, ]
df$quarter <- quarters(df$report_date)
df$year <- year(df$report_date)
df$Time <- as.yearqtr(paste(df$year, df$quarter))
df$trns_amount <- abs(df$trns_amount)

###----------------------------------[Step 5]------------------------------------###
df <- df %>% group_by(Time, fund_id) %>% transmute(
  quartVol = sum(trns_amount)
) %>% as.data.frame %>% unique()
df$Time <- as.POSIXct(df$Time)
```

## Summary
The first generated graphic shows entry and exit for various insurance funds, and the second graphic shows entry and exit for various brokers. A few notes are as follows: 

- First, take note of the y-axis scaling. There is much more entry/exit movement for funds than there is for brokers, by a magnitude of around 7x

- Continuing, we note that both plots indicate a downwards trend in both entry and exit movement. However, there are generally more exit individuals than entry individuals. I would note that this does not necessarily mean that the number of market participants is decreasing over time, as a fund can be considered an 'exit' fund without coming back as an entrant fund. For instance, consider the case in which a fund only makes trades in Q1 of each year. Then in Q4, it will always be recognized as an exit, but it will never be recognized as an entrant because of the volume traded in Q1. 

- Note the cyclical patterns in the brok_id exit patterns: there is typically a spike in exits around Q4/Q1. Recall that and exit means no trading volume for the previous two quarters. This would indicate lower trading volumes for many brokers in Q3/Q4 - unknown whether this is due to cyclical macro factors (i.e lower profitability) or over demand for bonds. 

- One more interesting factor is that the fund_id graphic shows entry and exit activity beginning to diverge around 2020, while the brok_id graphic maintains a downward cyclical trend over time. I think there is an interesting macroeconomic discussion to be had here, but I am suprised by the number of exits in the fund_id graph after 2020, as I would have expected more firms to shift funds into fixed income with a higher rate environment. 



I would say the primary limitation in this analysis and visualization is the disproportionate measurement of entry and exit activity. That is, a market participant could exit multiple times without there being a single entry recorded. 


```{r cars, echo=FALSE}
#Add all pairwise combinations of rows 
dates <- unique(df$Time)
fund_ids <- unique(df$fund_id)
pairs <- expand.grid(Time = dates, fund_id = fund_ids, stringsAsFactors = F)
pairs$quartVol <- 0

df <- rbind(df, pairs)
df <- df %>% group_by(Time, fund_id) %>% transmute(
  quartVol = sum(quartVol)
) %>% as.data.frame %>% unique()
df <- df %>%
  group_by(fund_id) %>%
  arrange(Time) %>%
  mutate(
    act4q = lag(quartVol, 4) + lag(quartVol, 3) + lag(quartVol, 2) + lag(quartVol, 1), 
    act2q = lag(quartVol, 2) + lag(quartVol, 1)
  )

df$act4q <- ifelse(df$Time < as.POSIXct("2005-12-31"), 0, df$act4q)
df$act2q <- ifelse(df$Time < as.POSIXct("2005-06-06"), 0, df$act2q)
df$entry <- ifelse(df$quartVol != 0 & df$act4q == 0, 1, 0)
df$exit <- ifelse(df$act4q > 0 & df$act2q == 0, 1, 0)

df <- df %>% mutate(
  exit = ifelse(lag(exit) == 1 & exit == 1, 0, exit)
)

out <- df %>% group_by(Time) %>% transmute(
  entry = sum(entry), 
  exit = sum(exit)
) %>% as.data.frame() %>% unique()
out <- out %>% filter(Time >= as.POSIXct("2006-01-01"))
out$Time <- as.yearqtr(out$Time)

out2 <- out %>%
  pivot_longer(c(entry, exit)) 
fundPlot <- ggplot(out2, aes(Time, value, color = name)) + geom_point() + geom_line() + scale_x_yearqtr(n = 10) + ggtitle("fund_id entry and exit by quarter") + ylab("Count")
fundPlot
```


```{r pressure, echo=FALSE}
setwd("C:/Users/hyper/OneDrive/Documents/GitHub/Insurance-Corporate-Bonds")
df <- readRDS('insurers_transactions.rds')
brokers <- read.csv('brokers.csv')

#Basic filtering conducted on the read-in data 
df <- df[df$trade_cost > 0, ]
df$quarter <- quarters(df$report_date)
df$year <- year(df$report_date)
df$Time <- as.yearqtr(paste(df$year, df$quarter))
df$trns_amount <- abs(df$trns_amount)

###----------------------------------[Step 5]------------------------------------###
df <- df %>% group_by(Time, brok_id) %>% transmute(
  quartVol = sum(trns_amount)
) %>% as.data.frame %>% unique()
df$Time <- as.POSIXct(df$Time)

#Add all pairwise combinations of rows 
dates <- unique(df$Time)
brok_ids <- unique(df$brok_id)
pairs <- expand.grid(Time = dates, brok_id = brok_ids, stringsAsFactors = F)
pairs$quartVol <- 0

df <- rbind(df, pairs)
df <- df %>% group_by(Time, brok_id) %>% transmute(
  quartVol = sum(quartVol)
) %>% as.data.frame %>% unique()
remove(pairs)
remove(dates)
remove(brok_ids)
remove(brokers)
gc()

df <- df %>%
  group_by(brok_id) %>%
  arrange(Time) %>%
  mutate(
    act4q = lag(quartVol, 4) + lag(quartVol, 3) + lag(quartVol, 2) + lag(quartVol, 1), 
    act2q = lag(quartVol, 2) + lag(quartVol, 1)
  )

df$act4q <- ifelse(df$Time < as.POSIXct("2005-12-31"), 0, df$act4q)
df$act2q <- ifelse(df$Time < as.POSIXct("2005-06-06"), 0, df$act2q)

#aggregate to count entrants and exits
df$entry <- ifelse(df$quartVol != 0 & df$act4q == 0, 1, 0)
df$exit <- ifelse(df$act4q > 0 & df$act2q == 0, 1, 0)

df <- df %>% mutate(
  exit = ifelse(lag(exit) == 1 & exit == 1, 0, exit)
)

out <- df %>% group_by(Time) %>% transmute(
  entry = sum(entry), 
  exit = sum(exit)
) %>% as.data.frame() %>% unique()
out <- out %>% filter(Time >= as.POSIXct("2006-01-01"))
out$Time <- as.yearqtr(out$Time)

out2 <- out %>%
  pivot_longer(c(entry, exit)) 

brokPlot <- ggplot(out2, aes(Time, value, color = name)) + geom_point() + geom_line() + scale_x_yearqtr(n = 10) + ggtitle("brok_id entry and exit by quarter") + ylab("Count")
brokPlot
```


